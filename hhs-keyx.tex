\documentclass{article}

\usepackage{amssymb, amsmath, amsthm}
\usepackage[utf8]{inputenc}
\usepackage[T1]{fontenc}
\usepackage{unicode}
\usepackage{tikz}
\usepackage{hyperref}
\usepackage[ruled, vlined, linesnumbered]{algorithm2e}
\SetEndCharOfAlgoLine{}

%Shortcuts
\newcommand{\F}{\mathbb{F}}
\newcommand{\Q}{\mathbb{Q}}
\newcommand{\Z}{\mathbb{Z}}
\newcommand{\C}{\mathbb{C}}
\newcommand{\Cl}{\mathcal{C}}
\newcommand{\Graph}{\mathcal{G}}
\renewcommand{\O}{\mathcal{O}}
\newcommand{\softO}{\tilde{O}}
\newcommand{\isom}{\overset{\sim}{\longrightarrow}}
\newcommand{\from}{\ensuremath{\,:\ }}
\newcommand{\set}[1]{\left\{#1\right\}}
\newcommand{\suchthat}{\,|\,}
\newcommand{\algstyle}[1]{\textsc{#1}}
\renewcommand{\v}{\vspace{5mm}}
\renewcommand{\frak}{\mathfrak}

\newtheorem{theorem}{Theorem}[section]
\newtheorem{prop}[theorem]{Proposition}
\theoremstyle{definition}
\newtheorem{prob}[theorem]{Problem}

\DeclareMathOperator{\End}{End}
\DeclareMathOperator{\Ker}{Ker}
\DeclareMathOperator{\Card}{Card}
\DeclareMathOperator{\Ell}{Ell}

\title{Towards practical key exchange from ordinary isogeny graphs}
\author{Luca De Feo, Jean Kieffer, Benjamin Smith}

\begin{document}

\maketitle

\begin{abstract}
\end{abstract}

\section{Introduction}
\label{sec:introduction}

A recent trend in cryptography is the development of quantum-safe
cryptosystems: protocols based on mathematical problems not known to
be solvable in polynomial time by quantum computers. With Shor's
algorithm~\cite{shor1994algorithms} ruling out systems based on
integer factorization or discrete logarithms, NIST has launched a
process to standardize the next generation of \emph{post-quantum}
public key cryptosystems~\cite{NIST2016}. In response, NIST has
received 69 proposals, most of them belonging to the three more
popular post-quantum families: lattice-based systems, code-based
systems, and multivariate systems. Among the youngest and least
explored families, \emph{isogeny-based} cryptography features only one
proposal to the NIST competition: the Supersingular Isogeny Key
Encapsulation (SIKE)~\cite{SIKE}.

SIKE is based upon the key-exchange protocol by Jao and De
Feo~\cite{jao+defeo2011}, known as SIDH, itself inspired by earlier
key-exchange constructions by Couveignes~\cite{cryptoeprint:2006:291}
and Rostovtsev and
Stolbunov~\cite{rostovtsev+stolbunov06,stolbunov-red,Stol}. The
origins of isogeny-based cryptography can be traced back to
Couveignes' seminal work ``Hard Homogeneous Spaces'' (HHS), that went
unpublished for ten years before appearing
in~\cite{cryptoeprint:2006:291}. Couveignes viewed HHS more as a
general framework, encompassing various flavors of Diffie-Hellman-like
systems, rather than as one particular protocol. Among the possible
instantiations of HHS, he suggested a new construction based on the
theory of complex multiplication of elliptic curves. It is however
Rostovtsev and Stolbunov who first gave
in~\cite{rostovtsev+stolbunov06} a concrete and detailed realization
of Couveignes' idea.

Rostovtsev and Stolbunov advertised their system as a potential
post-quantum candidate, leading Childs, Jao and Soukharev to introduce
the first sub-exponential quantum algorithm capable of breaking
it~\cite{childs2014constructing}. Hence, being already slow enough to
be unpractical in a classical security setting, the
Rostovtsev-Stolbunov system became even more unusable in a quantum
security setting. This led Jao and De Feo to create the SIDH
key-exchange protocol~\cite{jao+defeo2011}, which to the present day
is not victim to any sub-exponential attack.

The aim of the present paper is to improve and modernize the
Couveignes-Rostovtsev-Stolbunov construction, borrowing techniques
from SIDH and point-counting algorithms, to the point of making it
usable in a post-quantum setting. Although the final result is far
from being practical, we believe it constitutes progress in the
direction of having a valid isogeny-based alternative to SIDH.
Furthermore, our proposed scheme presents some distinct advantages
over SIDH, that we shall discuss in Section~\ref{todo}. While
preparing this paper we were informed of
% todo: say something on CSIDH

The paper is structured as follows.
% todo

\section{Isogenies and complex multiplication}
\label{sec:math}

We recall here basic facts on isogenies of elliptic curves defined
over finite fields. For an in depth introduction to these concepts, we
refer the reader to~\cite{silverman:elliptic}, and for a general
overview of isogenies and their use in cryptography we
suggest~\cite{defeo2017isogenybased}.

In what follows $\F_q$ is a finite field of characteristic $p$ with
$q$ elements, with an algebraic closure $\bar\F_q$. Let $E$ and $E'$
be elliptic curves defined over $\F_q$, an isogeny $ϕ:E→E'$ is a
non-constant algebraic map, mapping the point at infinity of $E$ to
the point at infinity of $E'$; it is also a group morphism from
$E(\bar\F_q)$ to $E'(\bar\F_q)$~\cite[III.4]{silverman:elliptic}. The
degree of an isogeny is its degree as an algebraic map; we will call
$ℓ$-isogeny an isogeny of degree $ℓ$.

An isogeny from a curve $E$ to itself is called an
\emph{endomorphism}.  Endomorphisms with the operations of addition
and composition form a ring, called the \emph{endomorphism ring} of
$E$ and denoted by $\End(E)$. Besides scalar multiplications, the
simplest example of endomorphism is the \emph{Frobenius map}
\begin{align*}
  π : E &→ E,\\
  (x,y) &↦ (x^q,y^q).
\end{align*}
As an element of $\End(E)$, it satisfies a quadratic equation
$π^2 + q = tπ$, where the integer $t$, called the \emph{trace} of $π$,
fully determines the order of $E$ as $\#E(\F_q)=q+1-t$. A curve is
called \emph{supersingular} if $p$ divides $t$, \emph{ordinary}
otherwise.

Any isogeny can be factored as a composition of a \emph{separable} and
a \emph{purely inseparable} isogeny. \emph{Purely inseparable}
isogenies have trivial kernel, and degree a power of
$p$. \emph{Separable} isogenies are in one-to-one correspondence with
their kernels: for any finite subgroup $G⊂E$ of order $ℓ$ there is a
unique elliptic curve $E'$ up to isomorphism, and a unique $ℓ$-isogeny
$ϕ:E→E'$ up to composition by the same isomorphism, such that
$\kerϕ=G$. All isogenies of degree coprime to $p$ are separable. A
\emph{cyclic isogeny} is one such that $\ker ϕ$ is a cyclic group. It
follows that any isogeny of degree greater than $1$ can be factored as
a composition of cyclic isogenies of prime degree.

For any $ℓ$-isogeny $ϕ:E→E'$, there is a unique $ℓ$-isogeny
$\hat{ϕ}:E'→E$ such that the compositions $ϕ∘\hat{ϕ}$ and $\hat{ϕ}∘ϕ$
are equal to the multiplication-by-$ℓ$ maps on $E'$ and $E$
respectively. $\hat{ϕ}$ is called the \emph{dual isogeny} to $ϕ$. This
shows that being \emph{$\ell$-isogenous} is an equivalence
relation. Further, a theorem of Tate states that two curves are
isogenous over $\F_q$ if and only if they have the same number of
points over $\F_q$.


\subsection{Isogeny graphs}

In isogeny-based cryptography one is mostly interested in
\emph{isogeny graphs}, i.e.\ (multi)-graphs which vertices are
elliptic curves up to isomorphism, and which edges are isogenies
between them. Because of the dual isogeny theorem, isogeny graphs are
typically considered undirected.

We denote by $E[ℓ]$ the subgroup of $ℓ$-torsion points of
$E(\bar\F_q)$.  If $ℓ$ is coprime to $p$, then $E[ℓ]$ is isomorphic to
$(ℤ/ℓℤ)^2$.  Furthermore, if $ℓ$ is prime $E[ℓ]$ contains exactly
$ℓ+1$ cyclic subgroups of order $ℓ$; it follows that, over $\bar\F_q$,
there are exactly $ℓ+1$ distinct (separable) $ℓ$-isogenies starting
from $E$.  Generically, a connected component of the isogeny graph of
$ℓ$-isogenies over $\bar\F_q$ will be an infinite $(ℓ+1)$-regular
graph; a notable exception is the finite connected component of
\emph{supersingular} curves, used in SIDH and related protocols.

If one restricts to isogenies \emph{defined over $\F_q$}, the picture
becomes more complex.  By definition, an isogeny $ϕ:E→E'$ is
\emph{defined over} $\F_q$ if and only if the Frobenius endomorphism
$π$ stabilizes $\ker ϕ$. If $ϕ$ is cyclic, this is equivalent to
saying that $π$ acts like a scalar on the points of $\ker ϕ$.  Thus,
for any prime $ℓ≠p$, the number of outgoing $ℓ$-isogenies from $E$ is
totally understood by looking at how $π$ acts on $E[ℓ]$. Since $E[ℓ]$
is a $ℤ/ℓℤ$-module of rank $2$, the action of $π$ is represented by a
$2×2$ matrix with entries in $ℤ/ℓℤ$ and characteristic polynomial
$X^2-tX+q\mod ℓ$. We then have four possibilities:
\begin{itemize}
\item[(0)] $π$ has no eigenvalues in $ℤ/ℓℤ$, i.e.\ $X^2-tX+q$ is
  irreducible modulo $ℓ$; then $E$ has no $ℓ$-isogenies.
\item[(1.1)] $π$ has one eigenvalue of (geometric) multiplicity one,
  i.e.\ it is conjugate to a non-diagonal matrix
  $\left(\begin{smallmatrix}λ&*\\0&λ\end{smallmatrix}\right)$; then
  there is one $ℓ$-isogeny from $E$.
\item[(1.2)] $π$ has one eigenvalue of multiplicity two, i.e.\ it acts
  like a scalar matrix
  $\left(\begin{smallmatrix}λ&0\\0&λ\end{smallmatrix}\right)$; then
  there are $ℓ+1$ isogenies of degree $ℓ$.
\item[(2)] $π$ has two eigenvalues, i.e.\ it is conjugate to a
  diagonal matrix
  $\left(\begin{smallmatrix}λ&0\\μ&0\end{smallmatrix}\right)$; then
  there are two isogenies from $E$.
\end{itemize}

If we denote by $d_π=t^2-4q$ the discriminant of the characteristic
equation of $π$, we see that the cases~(1.x) are only possible if $ℓ$
divides $d_π$.  For ordinary curves $d_π≠0$, thus only a finite number
of primes $ℓ$ will fall in these cases, and they will be mostly
irrelevant to our cryptosystem. Following the literature on the SEA
point-counting algorithm~\cite{schoof95,todo}, if $ℓ$ falls into
case~(0) it will be called an \emph{Atkin prime}, if it falls into
case~(2) it will be called an \emph{Elkies prime}.

We will chiefly be interested in Elkies primes. Since all curves in
the same isogeny class over $\F_q$ have the same number of points,
they also have the same trace $t$ and discriminant $d_π$. It follows
that, if $ℓ$ is an Elkies prime for a curve $E$, the connected
component of $E$ in the graph of $ℓ$-isogenies is a finite $2$-regular
graph, i.e.\ a cycle. In the next subsection we introduce a group
action on this cycle, and determine its size.


\subsection{Ordinary elliptic curves and the theory of complex multiplication}

An elliptic curve $E/k$ is called \emph{ordinary} when its endomorphism ring $
\End(E)$ is an order in a quadratic imaginary field (other curves are called 
\emph{supersingular} and their endomorphism rings are orders in a quaternion 
algebra). Here, an \emph{order} is a subring which is a $\Z$-module of maximal 
rank. 

From now on we will restrict attention to ordinary curves and rational 
isogenies. For example, we will call two curves $E$ and $E'$ \emph{isogenous} 
if there exists a rational isogeny from $E$ to $E'$. This is an equivalence 
relation: according to a theorem of Tate, $E$ and $E'$ are isogenous if and 
only if they have the same number of points over $k$. Hasse's theory then 
implies that the rings $\Z[\pi_E]$ and $\Z[\pi_{E'}]$ are naturally isomorphic 
(the endomorphism
$\pi_{E'}$ being the image of $\pi_{E}$): indeed we have for any curve
\[
\pi_E^2 - t_E\pi_E + q = 0
\]
where $t_E$ is an integer such that
\[
\Card(E(k)) = p + 1 - t_E.
\]
These rings are of finite index in the endomorphism rings, and as a consequence 
$\End(E)$ and $\End(E')$ can be viewed as orders in the \emph{same} quadratic 
imaginary field $K = \Z[\pi_E]\otimes\Q$. Furthermore, these isomorphisms can 
be made coherent across an isogeny class in the sense that the Frobenius 
endomorphism always corresponds to the same element of $K$, as we will assume
from now on.

If $\phi\from E\to E'$ is an $\ell$-isogeny, then the orders $\End(E)$ and $\End
(E')$ are very close to each other. One has the following classification: either
\[
\begin{aligned}[l]
&\End(E) = \End(E'),
&\qquad\text{$\phi$ is then called \emph{horizontal}, or} &\\
&[\End(E):\End(E')] = \ell,
&\qquad\text{$\phi$ is then called \emph{descending}, or} &\\
&[\End(E'):\End(E)] = \ell,
&\qquad\text{$\phi$ is then called \emph{ascending}.} &
\end{aligned}
\]

We now present the group action used in the Rostovtsev--Stolbunov key exchange 
protocol. Let $\frak a$ be an ideal in $\End(E)$. Then we have a natural \emph
{${\frak a}$-torsion} subgroup of $E$ to look at, namely the subgroup of points
that are killed by the endomorphisms belonging to $\frak a$:
\[
E[\frak a](\bar{k}) = \set{P\in E(\bar{k}) \suchthat \sigma(P) = 0\ 
\forall\sigma\in\frak a}.
\]
This subgroup is the kernel of a rational isogeny $\phi_{\frak a}$ that is well-
defined up to postcomposition by an isomorphism, hence the codomain of $\phi_{
\frak a}$ is well-defined up to isomorphism over $\bar{k}$. We will call this 
codomain $\frak a\cdot E$, in other words
\[
\frak a\cdot E = E/E[\frak a].
\]

The isogeny $\phi_{\frak a}$ is always horizontal, hence we have $\End(\frak a
\cdot E) = \End(E)$, and its degree is the \emph{norm} of $\frak a$ as an ideal 
of $\End(E)$.
Let us call $\Ell_k(\O)$ the set of isomorphism classes over $\bar{k}$ of 
curves whose endomorphism ring is isomorphic to $\O$. It turns out that the 
construction above may be extended into a group action: namely, the group of 
fractional ideals of $\End(E)$ acts on the set $\Ell_k(\End(E))$. Furthermore, 
principal ideals act trivially, so that this action factorises as an action of 
the \emph{ideal class group} $\Cl(\End(E))$ on the set $\Ell_k(\End(E))$.

The main theorem of complex multiplication states that this action is \emph{
simply transitive}; in other terms, $\Ell_k(\End(E))$ is a principal 
homogeneous space under the group $\Cl(\End(E))$. If we fix a curve $E$ as a 
base point, we thus have a bijection
\[
\begin{aligned}
\Cl(\End(E)) &\to \Ell_k(\End(E)) \\
\text{Ideal class of }\frak a &\mapsto \text{Isomorphism class }\frak a\cdot E.
\end{aligned}
\]

Remember that the Frobenius characteristic equation
\[
X^2 - t_E X + q = 0
\]
of discriminant $\Delta_E$ is a defining equation for the field $K = \End(E)
\otimes\Q$. The discriminant of $\End(E)$ divides $\Delta_E$ since $\End(E)$ 
contains the ring $\Z[\pi_E]$. Hence, we can summarize the previous discussion 
in the following way: let $\ell$ be an odd prime, prime to the characteristic. 
Then either
\begin{enumerate}
\item $\Delta_E$ is not a square modulo $\ell$. Then $\ell$ is Atkin, the Frobenius
characteristic equation has no root in $\Z/\ell\Z$ and so there 
are no rational $\ell$-isogenies starting from $E$. The prime $\ell$ is inert 
in $K$, so that there are no ideals of norm $\ell$ in $\End(E)$.
\item $\Delta_E$ is nonzero and a square modulo $\ell$. Then $\ell$ is Elkies, 
and there are exactly two $\ell$-isogenies starting from $E$ whose directions 
are the two Frobenius eigenvalues modulo $\ell$ (i.e. the two roots of the
characteristic equation in $\Z/\ell\Z$). They are horizontal since $\ell
$ is prime to $\Delta_E$. The prime $\ell$ splits in $K$, and there are two 
ideals of norm $\ell$ in $\End(E)$ that are complex conjugates of each other, $
\frak a_\ell$ and $\frak a_\ell^{-1}$. One can show that the action of the 
ideal $\frak a_\ell$ in always given by $\ell$-isogenies in the same direction $
v$, which satisfies
\[
\pi_E = v \mod \frak a_\ell.
\]
Of course, the same is true for $\frak a_\ell^{-1}$. Since the eigenvalues are 
distinct, we may safely label the ideal $\frak a_\ell$ with the pair $(\ell, 
v)$.
\item $\Delta_E$ is zero modulo $\ell$. Then $\ell$ is ramified. The situation 
is more complicated: there can be either zero or one ideal of norm $\ell$ in $
\End(E)$, depending on its conductor, and there may be non-horizontal 
isogenies. In any case, all these isogenies are associated with the same 
Frobenius eigenvalue.

\end{enumerate}

As we will see, only the Elkies primes for a given curve can be used in the
Rostovtsev--Stolbunov scheme.

\subsection{Modular curves}

Elliptic curves equipped with $\ell$-isogenies (or, more generally, some 
additional structure) can be naturally identified to \emph{points} on a 
mathematical object called a \emph{modular curve}. Constructing modular curves 
in general is not easy, and we will simply recall here some well-known 
properties. As above, let $\ell$ be a prime distinct from the characteristic of 
$k$. 
Then there exists a smooth curve $X_0(\ell)$ defined over $k$ with the 
following property: there is a bijection
\[
X_0(\ell)(k) \isom \set{
\begin{matrix}
\text{Isomorphism classes over $\bar{k}$ of pairs $(E, G)$}\\
\text{where $G$ is a subgroup of order $\ell$ defined over $k$.}
\end{matrix}
}
\]

Of course, this is not a mere bijection: it is functorial in $k$, and either
side can be deduced from the other by algebraic means.
In this work, we use modular curves presented as \emph{plane curves} up to 
birational equivalence, i.e. given as an equation of the form
$\Phi(X, Y) = 0.$
In order to find such an equation, it is enough to find to functions $X$ and $Y$
 on the curve that generate its function field. One can obtain an equation for $
X_0(\ell)$ using the two functions
\[
\begin{aligned}
X(E, G) &= j(E), \\
Y(E, G) &= j(E/G)
\end{aligned}
\]
where $j(E)$ denotes the $j$-invariant of the elliptic curve $E$. Indeed, $X$ 
and $Y$ are well defined and algebraic, and can be shown to generate the 
function field of $X_0(\ell)$. They are linked by a polynomial equation
\[
\Phi_\ell(X, Y) = 0
\]
where $\Phi_\ell$ is called the \emph{classical modular polynomial} of level $
\ell$, and has coefficients in $\Z$. The polynomial $\Phi_\ell$ can be
obtained in several ways; from a practical point of view, it is enough to have
computed it once and store it for further use.

These polynomials quickly become difficult to compute, hence one uses different 
functions on $X_0(\ell)$ when $\ell$ becomes large, giving rise to the 
so-called \emph{Atkin} modular polynomials. The classical polynomial $\Phi_\ell$ 
is still arguably the simplest to use, since one only has to solve the 
polynomial equation $\Phi_\ell(j(E), Y) = 0$ to find the $j$-invariants of 
curves linked to $E$ by an $\ell$-isogeny. Here one sees how equations of 
modular curves can be used in the context of isogeny computations.

In general, the curve $\Phi(X, Y) = 0$ is no longer smooth: for example, double 
points may appear, so that $k$-points on this curve are no longer in bijection 
with geometric data (elliptic curves with some structure up to isomorphism)
as above. Still, plane equations are useful. For example, 
one can show that double points of $X_0(\ell)$ in the coordinates $X, Y$ 
correspond to elliptic curves $E$ that have a nontrivial endomorphism of degree 
$\ell^2$, and this is easily controlled: in particular it cannot be the case
when the discriminant of $\End(E)$ is greater than $\ell^2$.


\section{The Rostovtsev--Stolbunov key-exchange protocol}
\label{sec:keyex}

\subsection{Key exchange from abelian Cayley graphs}

The Rostovtsev--Stolbunov key-exchange protocol is an instance of a general
framework of key exchanges using abelian Cayley graphs. This general pattern
is in turn an example of Couveignes' `Hard Homogeneous Spaces' key echange
framework.

Let us first describe this general
setting before discussing more specific algorithms used in isogeny computations.
The public data is
\begin{itemize}
\item A finite abelian group $G$;
\item A finite set $S$ of elements of $G$;
\item A finite set $X$ on which $G$ acts simply transitively;
\item A fixed element $x_0\in X$;
\item For each $s\in S$, an integer $M_s\geq 1$.
\end{itemize}
We further ask that the action of $G$ on $X$ be \emph{computable}, in the sense
 that there is an algorithm \algstyle{Step} which, given $s\in S$ and $x\in X$ as
input, computes the element $s\cdot x$. To explain the name, let $\Graph(G, S, X)$
be the oriented graph whose vertices are the elements of $X$, and an edge labelled
by $s\in S$ links $x_1$ to $x_2$ if $s\cdot x_1 = x_2$; then the algorithm
\algstyle{Step} allows us to follow one edge in the graph. The graph $\Graph(G, S, X)$
may be (at least theoretically, if not computationally) identified with the usual
Cayley graph associated with the abelian group $G$ and the set $S$ of generators.
Indeed we will see that the security of such schemes relies on the infeasibility
of this identification.

As usual, two participants Alice and Bob want to build a common secret while
communicating over an insecure channel. They may
achieve this using the public data above as
described in algorithms \ref{alg:keyex}, \ref{alg:key} and \ref{alg:walk}.

\begin{algorithm}
    \caption{\algstyle{KeyExchange}: key exchange using an abelian Cayley graph}
    \label{alg:keyex}
    \KwIn{Public data as above}
    \KwOut{A secret $x_S\in X$ shared by Alice and Bob}
    %		
    Alice does\\
			\quad $K_A \gets$ \algstyle{KeySample}()\;
			\quad $x_A \gets$ \algstyle{Walk}$(K_A, x_0)$\;
			\quad \textbf{publish} $x_A$ \;
		Bob does\\
			\quad $K_B \gets$ \algstyle{KeySample}()\;
			\quad $x_B \gets$ \algstyle{Walk}$(K_B, x_0)$\;
			\quad \textbf{publish} $x_B$ \;
		Alice does\\
			\quad $x_{S, A}$ = \algstyle{Walk}$(K_A, x_B)$\;
		Bob does\\
			\quad $x_{S, B}$ = \algstyle{Walk}$(K_B, x_A)$\;
		\Return $x_S = x_{S, A} = x_{S, B}$
\end{algorithm}

\begin{algorithm}
	\caption{\algstyle{KeySample}: construction of an ephemeral key}
	\label{alg:key}
	\KwIn{Public data as above}
	\KwOut{An ephemeral key}
	%
	\For{$s\in S$}{
		$k_s \overset{R}{\gets} [0, M_s]$ \quad (uniformly at random)
	}
	\Return{$(k_s)_{s\in S}$}
\end{algorithm}

\begin{algorithm}
	\caption{\algstyle{Walk}: a walk in the abelian Cayley graph}
	\label{alg:walk}
	\KwIn{Public data as above; an ephemeral key $K = (k_s)_{s\in S}$; a point $x_I\in X$}
	\KwOut{The element $x_F = (\prod_{s\in S} s^{k_s})\cdot x_I$}
	%
	$x_F\gets x_I$\;
	\For{$s\in S$}{
		\lFor{\(0 \le i < k_s\)}{
			$x_F\gets$ \algstyle{Step}$(s, x_F)$
		}
	}
	\Return $x_F$
\end{algorithm}

As the reader may see, this key exchange framework is based on the computation
of several walks in the graph $\Graph(G, S, X)$. Alice and Bob are allowed to
compute steps in the directions specified by the elements of $S$, and the integers
$M_s$ play the role of the maximal number of steps that will be computed
for each generator. Of course, when both $s$ and $s^{-1}$ appear in $S$, one
of $k_s$ and $k_{s^{-1}}$ has to be zero, since the steps would otherwise
annihilate each other.
An important remark is that there is no need to represent
elements of $G$ at all in this protocol, or to compute with them directly,
outside the algorithm \algstyle{Step}.

When designing practical instances of abelian Cayley graph
protocols, the main degrees of liberty are the choice of the generators themselves,
and the bounds $M_s$. The cost of the key exchange is a weighted
sum of the $M_s$, while the key space size is the product of these integers. When
the number of generators is sufficient, there is therefore an exponential gap
between the key space size and the cost of the walks.

Of course, in order to be
cryptographically interesting, the action of the group $G$ on $X$ must in particular
be difficult to \emph{invert}: $x_1, x_2\in X$ being given, finding a combination
$g\in G$ of the generators such that $g\cdot x_1 = x_2$. must be a hard problem.
This is the main reason why this framework cannot usually be used with
Cayley graphs given by multiplication in the group, since division in $G$ is usually
a simple operation. To be more precise, the security of this key exchange relies
on the difficulty of the following Diffie--Hellman-like problems:

\begin{prob}[Group Action Decisional Diffie--Hellman (GADDH) problem] Let $x, y\in X$,
$a, b\in G$. Given $x,\ y,\ a\cdot x$ and $b\cdot x$, decide whether $(ab)\cdot x = y$.
\end{prob}

\begin{prob}[Group Action Computational Diffie--Hellman (GACDH) problem] Let $x\in X$,
$a, b\in G$. Given $x,\ a\cdot x$ and $b\cdot x$, compute $(ab)\cdot x$.
\end{prob}

For a particular family of group actions, we will call GADDH assumption the assumption
that the GADDH problem is computationally infeasible, in the sence that the advantage
given by any polynomial-time algorithm is a negligible function of the security parameter
$\log|G|$.

\subsection{Presentation of the protocol}

The idea of Rostovtsev and Stolbunov is to instanciate the general framework of
key exchange based on abelian group actions using isogenies between ordinary elliptic
curves. Let us fix an ordinary elliptic curve $E_0$ over a finite field $k$, with
endomorphism ring $\O$. Then the ideal class group of $\O$ will play the role of
the abelian group $G$, and the set $X$ is the set $\Ell_k(\O)$ of elliptic curves
with endomorphism ring $\O$.

We also have to describe the set $S$ of generators used. Let $L$ be a list of
small Elkies primes for the curve $E_0$, as defined in section \ref{sec:math}.
Then for each $\ell\in L$, there exists two ideals in $\O$ of norm $\ell$, which
are inverses of each other. These ideal classes will be the elements of $S$. According to
the discussion in section \ref{sec:math}, we may identify these ideal classes with
pairs $(\ell, v)$, where $v$ is one of the two Frobenius eigenvalues modulo $\ell$.

Now the description of algorithm \algstyle{Step} (algorithm \ref{alg:step}) is a direct consequence of
the previous discussions. The subroutine \algstyle{IsogenyKernel}$(E, \ell, j_1)$
is an algorithm which computes the kernel of an isogeny from $E$ to an elliptic curve
with $j$-invariant $j_1$, and that we will discuss in the following section.
As before, we identify isomorphism classes of curves with
$j$-invariants.

\begin{algorithm}
	\caption{\algstyle{Step}: a step in an ordinaty isogeny graph}
	\label{alg:step}
	\KwIn{A generator $(\ell, v)$; an isomorphism class $j_I\in \Ell_k(\O)$; a curve $E_I$
		such that $j(E_I) = j_I$; the classical
		modular polynomial $\Phi_\ell(X, Y)$}
	\KwOut{The isomorphism class $j_F$ given by the action of $(\ell, v)$ on $j_I$}
	%
  $P\gets \Phi_\ell(j_I, Y)$\;
	$j_1, j_2 \gets$ \algstyle{Roots}$(P, k)$\;
	$K_1\gets $ \algstyle{IsogenyKernel}$(E_I, \ell, j_1)$\;
	\lIf{\algstyle{HasFrobeniusEigenvalue}$(K_1, v)$}{\Return $j_1$}
	\lElse{\Return $j_2$}
\end{algorithm}

According to section \ref{sec:math}, this algorithm is valid if the discriminant
of $\O$ is larger than $\ell^2$.
Note that in algorithm \ref{alg:step}, there is no need to know the endomorphism
ring $\O$, to compute directly with ideals or to be able to compute the set
$\Ell_k(\O)$. In order to use this
protocol, one only has to know which primes are Elkies for the curve $E_0$,
and this is easy once we know the Frobenius characteristic equation on $E_0$.
This is equivalent to computing the cardinality of $E_0$, which is
done in polynomial time using Schoof's algorithm. If we replace $v$ with the other
Frobenius eigenvalue modulo $\ell$ in algorithm \ref{alg:step}, we will compute
a step in the direction specified by the other ideal of norm $\ell$: therefore
we are able to use both of them as generators.

According to section \ref{sec:math}, we may give another version for the
algorithm \algstyle{Step}, described in algorithm \ref{alg:steptors}.

\begin{algorithm}
	\caption{\algstyle{Step2}: another way of computing a step in the isogeny graph}
	\label{alg:steptors}
	\KwIn{A generator $(\ell, v)$; an isomorphism class $j_I\in \Ell_k(\O)$; a curve $E_I$
		such that $j(E_I) = j_I$; the classical
		modular polynomial $\Phi_\ell(X, Y)$}
	\KwOut{The isomorphism class $j_F$ given by the action of $(\ell, v)$ on $j_I$}
	%
	$r\gets$ \algstyle{MultiplicativeOrder}$(v, \F_\ell)$\;
	$k_{ext}\gets$ \algstyle{Extension}$(k, r)$\;
	$P_{ext}\gets$ \algstyle{TorsionPoint}$(E_I, \ell, k_{ext})$\;
	$K\gets$ \algstyle{Subgroup}$(P_{ext})$\;
	$E_F\gets$ \algstyle{Quotient}$(E_I, K)$\;
	\Return $j(E_F)$
\end{algorithm}

Algorithm \ref{alg:steptors} is valid when the Frobenius eigenspace with eigenvalue $v$ is
the only line in $E[\ell](\bar{k})$ whose points are defined over the degree $r$ extension
$k_{ext}$ of $k$. In other words, it is valid when the multiplicative order of $v$ in
$\F_\ell$ is strictly smaller than the multiplicative order of the second eigenvalue.
In any case, only one of the two ideals of norm $\ell$ can be eligible for algorithm
\ref{alg:steptors} as it stands.

Let us now describe the primitives about isogeny computations used in algorithms
\ref{alg:step} and \ref{alg:steptors}. This will allow us to compare the merits
of these two algorithms, which is directly related to the choice of the public
parameters.


\section{Algorithms and parameter selection}

We keep the notations of sections \ref{sec:math}
and \ref{sec:keyex}. In order to analyse the costs of various parts of the
algorithm, we make some complexity estimates in terms of operations in the
base field $k$ of order $q$.
We will use the soft-$O$ notation: a cost $\softO(f(\ell, \log q))$ means
$O(f(\ell, \log q)^{O(1)})$. These complexity estimates will also
allow us to discuss the relative costs of algorithms \ref{alg:step} and
\ref{alg:steptors}, and guide us in the later choice of the primes $\ell$
and bounds $M_\ell$ for the number of steps that we will finally propose.

\subsection{Description of the subroutines}

In this paragraph, we turn on to algorithms appearing in algorithms \ref{alg:step}
and \ref{alg:steptors} that are somewhat specific to the Rostovtsev-Stolbunov
scheme; generic isogeny computation as in \algstyle{Quotient} will be discussed
in the following paragraph.
\v

Let us first delve into algorithm \ref{alg:step}.
The reader will agree that the purpose of the subroutines \algstyle{Roots}
and \algstyle{MultiplicativeOrder} is clear. Remember that the
prime $\ell$ is very small compared to the order of $k$. Therefore we use the
well-known Cantor--Zassenhaus method in \algstyle{Roots}:
given a polynomial $P$,
we compute $F = X^q \mod P$ using a fast exponentiation method, and then the polynomial
$\gcd(F - X, P)$ is the product of irreducible factors of degree one in $P$
in $k[X]$. In our setting the modular equation has two roots: therefore we only need
to compute square roots to complete \algstyle{Roots}, which is
done using the Tonnelli--Shanks algorithm. The cost is dominated
by that of computing $F$: when $P$ is a modular equation
of level $\ell$, hence degree $\ell + 1$, this costs $\softO(\ell\log q)$ operations in $k$
using asymptotically fast methods for polynomial arithmetic. As for \algstyle{MultiplicativeOrder},
any version of it will do, including the really naive one consisting in computing
all the powers of $v$ until one is equal to 1.

Algorithm \algstyle{HasFrobeniusEigenvalue}
involves computing the Frobenius on the kernel: more precisely, one computes $(X^q, Y^q)$
where $q$ is the order of $k$ in the quotient ring
\[
k[X, Y]/(K(X),\ Y^2 - X^3 - aX - b)
\]
where $a, b$ are given by the curve equation $y^2 = x^3 + ax + b$. Here, the polynomial
$K(X)$ is the degree $\frac{\ell-1}{2}$ polynomial whose roots are the $x$-coordinates of the elements
in the subgroup of order $\ell$. One then checks whether it is equal to $v$ times the generic
point $(X, Y)$ which is computed using the addition law on the curve. In fact, computing
in the double quotient ring above is not even needed. The two quantities we want to compute,
$(X^q, Y^q)$ and $[v](X, Y)$, have a $Y$ factor only in their second coordinate. Thus one
can only store univariate polynomials in $X$ and multiply by the square of $Y$, that is
$X^3 + aX + b$, at appropriate places in the addition algorithm on the curve. Thus the
computations are really done in the ring $k[X]/K(X)$. An addition of points in this
quotient ring amounts to a constant number of multiplications and additions of degree $\ell$
polynomials, which can be done in $\softO(\ell)$ field operations using
asymptotically fast algorithm. The cost for the scalar multiplication is therefore also
$\softO(\ell)$ using a binary exponentiation process. However, the cost of computing
$(X^q, Y^q)$ is $\softO(\ell\log q)$ as in the Cantor--Zassenhaus algorithm above.

There is one last subroutine in algorithm \ref{alg:step} that is important to discuss,
namely the evaluation (and the storage) of the bivariate polynomial $\Phi_\ell$. It is a bivariate
polynomial of degree $\ell + 1$ in both variables, which is not sparse and whose coefficients
grow quickly. Therefore in first approximation, even its storage could cost as much as
$\O(\ell^2 \log q)$ when the coefficients are reduced in $k$. However, it is in practice a negligible
part of the algorithm: when the classical modular polynomials become too cumbersome to store, we
switch to Atkin modular polynomials. If one wants to use modular equations of yet higher levels,
one can compute directly the classical modular polynomial evaluated at an element in $k$,
with a cost that is linear in the level. However, using such methods is not mandatory in
the context of the Rostovtsev--Stolbunov key exchange, and Atkin modular polynomials are
sufficient.
\v

As for algorithm \algstyle{Step2}, the algorithm \algstyle{Torsion} works as follows.
The cardinality $C_{ext}$ of $E(k_{ext})$ is easily computed from $\Card(E(k))$
and the degree of the extension using Hasse's theory.
Then, pick a random point $Q_{ext}$ on the curve defined over $k_{ext}$ and compute
\[
P_{ext} = \left[\frac{C_{ext}}{\ell}\right]Q_{ext}
\]
until $P_{ext}$ is not the point at infinity. Then $P_{ext}$ is a correct answer.
In general, very few scalar multiplications have to be computed (usually one),
but they involve points defined over $k_{ext}$: if $r$ denotes the degree of
this field over $k$, then all coordinates are written as polynomials of degree
$r$. The size of $C_{ext}$ is that of $q^r$, so that the amount of $k$-operations
 involved is $\softO(r^2\log q)$ using a binary scalar multiplication mechanism.

Once this torsion point $P_{ext}$ is computed, \algstyle{Subgroup} computes its
multiples $[i]P_{ext}$ for every $1\leq i\leq \frac{\ell - 1}{2}$ and collects
their abscissas. This is done using $\softO(r\ell)$ operations in $k$, as
these points are again defined over $k_{ext}$.

\subsection{Isogeny computations}

The algorithms \algstyle{IsogenyKernel} and \algstyle{Quotient} appearing in
algorithms \ref{alg:step} and \ref{alg:steptors} are well-known primitives in isogeny
computations. 

In general, the case of even-degree isogenies is
more complicated than that of odd-degree isogenies. Since we are only
interested in prime-degree isogenies and the prime 2 is never Elkies, we
will content ourselves with the odd-degree case.

The \algstyle{Quotient} algorithm directly uses Vélu's formulas, which are
summarised in the following theorem.
\begin{theorem}[Vélu]
Let $E$ be an elliptic curve in short Weierstrass form
\[
E\ :\ y^2 = x^3 + a x + b
\]
and $\ell$ be an odd prime. Let $K(X)$ be a polynomial representing a subgroup $G$
of order $\ell$ on $E$, in the sense that $K(X)$ is the monic polynomial of degree
$n = \frac{\ell - 1}{2}$ whose roots are the $x$-coordinates of the points in $G$.
We write
\[
K(X) = X^n - \sigma_1 X^{n-1} + \cdots + (-1)^n \sigma_n.
\]
($\sigma_i = 0$ if $i>n$).
Then the curve $E/G$ has (up to isomorphism) the following equation:
\[
E/G\ :\ y^2 = x^3 + a' x + b'
\]
with
\[
\begin{aligned}
a' &= a - 5t,\\
b' &= b - 7w
\end{aligned}
\]
where we define
\[
\begin{aligned}
t &= 6 (\sigma_1^2 - 2\sigma_2) + 2 a n,\\
w &= 10 (\sigma_1^3 - 3 \sigma_1\sigma_2 + 3\sigma_3) + 6 a\sigma_1 + 4bn.
\end{aligned}
\]


\end{theorem}

As one can see, algorithm \algstyle{Quotient} only costs a constant number
of operations in $k$ (not even in $k_{ext}$, as the polynomial $K$ has
coefficients in $k$ although it was built from its roots in $k_{ext}$).
\v

As the reader can see, computing a quotient is easy. On the other hand,
computing the kernel of an isogeny given its domain, degree and image is a
somewhat more difficult problem. A rich literature exists on this subject,
so that we will content ourselves with the larger picture.

If the characteristic $p$ of $k$ is very small, $p$-adic methods to compute
the kernel of the isogeny may be used. When $p$ is not that small, but not
much larger than $\ell$ (typically $p < 8\ell$), other methods based on
interpolation or formal groups have to be used: this case is considered to
be the difficult one. Since we plan on using the Rostovtsev--Stolbunov scheme
in large characteristic, we will concentrate on this setting, i.e. we assume
$p\gg\ell$. In this case, several algorithms exist, and many of them
rely on computing a power series solution to a differential equation.
Unfortunately, using this principle in smaller characteristic may lead to
divisions by zero. We will follow Elkies' document \ldots, which studied
this problem in the context of the SEA algorithm for point couting on
elliptic curves. It is not the asymptotically fastest algorithm available,
but using it does not lead to significant slowdown in our range of applications.

To describe this algorithm, it is convenient to describe isogenies as
rational fractions of the coordinates $x$ and $y$ on the curve. In fact, these
rational fractions can be written in a simple way:

\begin{prop}
Let $\phi$ be an $\ell$-isogeny between two elliptic curves written in
Weierstrass form
\[
E\ :\ y^2 = x^3 + ax + b, \quad E_1\ :\ y^2 = x^3 + a_1x + b_1.
\]
Then there exists polynomials $N$ and $D$ of degrees $\ell$ and $\ell-1$,
and a constant $c\in k^*$, such that $D$ is monic and
\[
\phi(x, y) = \left(\frac{N(x)}{D(x)}, cy\left(\frac{N}{D}\right)'(x)\right).
\]
The polynomial $D$ is the square of the kernel polynomial of $\phi$, as defined
above. Denoting by $\phi_x$ the rational fraction $\frac{N}{D}$,
the following differential equation holds:
\[
c(x^3 + ax + b)\phi_x'^2(x) = \phi_x^3 + a_1\phi_x + b_1,
\]
whence
\begin{equation}
\label{diffeq}
2c(x^3 + ax + b)\phi_x'' + c(3x^2 + a)\phi_x' =
 3\phi_x^2 + a_1.
\end{equation}
\end{prop}

We will call $\phi$ \emph{normalised} if the coefficient $c$ is equal to 1.
This property is not intrinsic: it depends on the particular model chosen
for $E$ and $E_1$.

Elkies' strategy for algorithm \algstyle{IsogenyKernel}$(E, \ell, j(E_1))$ can now be described
as follows:
\begin{itemize}
\item Determine an equation for $E_1$ from the equation of $E$, $\ell$ and
 $j(E_1)$ such that the $\ell$-isogeny $\phi$ is normalised.
\item Solve equation \ref{diffeq} in the world of power series in $x^{-1}$ over $k$, up to
 some precision $N$: that is, write
\[
\frac{N(x)}{D(x)} = x + c_0 + c_1 x^{-1} + \cdots + c_N x^{-N} + O(x^{-N-1}).
\]
\item Recover $D$ and the kernel polynomial from $\phi_x$ using rational
 fraction reconstruction.
\end{itemize}

Since we want to determine a polynomial of degree $\ell-1$, choosing a precision $N = 2\ell$
is sufficient when using standard rational reconstruction algorithms such as Berlekamp--Massey.

Let us first describe how equation \ref{diffeq} is solved. One readily
has the following relations between the coefficients $c_k$: for all $k\geq 2$,
\begin{equation}
\label{eq:rec}
 (k-1)(2k+5)c_{k+1} = 3\sum_{i=1}^{k-1}c_i c_{k-i}
	- (2k-1)(k-1)a c_{k-1} - (2k-2)(k-2)b c_{k-2}.
\end{equation}
This relation gives $c_{k+1}$ in terms of the previous coefficients provided $k-1$
and $2k+5$ are invertible.

This recursion is initialised using the following remark: since $\phi$,
it \emph{is} the isogeny given by Vélu's formulas starting from its kernel. Thus
one has
\[
c_0 = 0,\quad c_1 = \frac{a - a_1}{5},\quad c_2 = \frac{b - b_1}{7}.
\]
This leads to an algorithm which costs $O(\ell^2)$ operations in $k$, since each
application of equation \ref{eq:rec} has a linear cost, and one as to compute
$c_k$ for all $k\leq 2\ell$. The characteristic must be greater than $4\ell+3$
for this algorithm to work.

Let us now describe how to compute an equation for $E_1$ such that the isogeny
is normalised. One also uses modular polynomials for this task:

\begin{prop}
Let $E\ :\ y^2 = x^3 + ax + b$ be an elliptic curve over $k$
 and $\ell$ be an odd prime number. Let $j = j(E)$ and $j_1$
be a root of the equation
\[
\Phi_\ell(j, Y) = 0
\]
where $\Phi_\ell$ is the classical modular polynomial of level $\ell$.
Define
\begin{equation}
\label{eq:norm}
\begin{aligned}
\lambda &= 18 j \ell \frac{b}{a}\ 
	\frac{\frac{\partial \Phi_\ell}{\partial X}(j, j_1)}
			 {\frac{\partial \Phi_\ell}{\partial Y}(j, j_1)},\\
a_1 &= -\frac{\lambda^2}{48 j_1(j_1 - 1728)},\\
b_1 &= \frac{\lambda^3}{864 j_1^2(j_1 - 1728)}.
\end{aligned}
\end{equation}
Then the elliptic curve $E_1\ :\ y^2 = x^3 + a_1x + b_1$ has $j$-invariant $j_1$,
and there is a normalised isogeny from $E$ to $E_1$.
\end{prop}

These formulas can be proved over the field $\C$ of complex numbers using
modular forms, just as the properties relating $\Phi_\ell$ to $\ell$-isogenies.
One can then show that these formulas remain true over a finite field.
They cannot be applied if $j$ is equal to zero, or $j_1$ is equal to 0
or 1728. In practice, it is easy to detect curves that are isogenous
to one of these failure cases (see \ldots), and discard them from the beginning.

\v
To end this section, let us remark that these computations can be extended to
other models for elliptic curves, and also to other types of modular polynomials.
See \ldots for the use of Atkin modular polynomials in this context, and \ldots
for an analogue of Vélu's formulas using Montgomery equations for curves.

Several optimisations are available to the algorithm \algstyle{IsogenyKernel}
as sketched here. First, one can avoid the rational reconstruction step and
find the coefficients of the kernel polynomial directly from the $c_k$'s,
and an additional quantity that can be computed using the modular equation.
This is how Elkies originally presented this method. Second, one can avoid
the quadratic step \ref{eq:rec} by performing Newton iterations on power
series that satisfy a related differential equation: see \ldots. Finally,
let us mention that the quasi-linear methods available to compute the
polynomial $\Phi_\ell$ evaluated at a point also allow to compute the
derivarives of this polynomial that appear in equation \ref{eq:norm}.


\subsection{Cost analysis}



Faire une première remarque qu'il est plus efficace d'utiliser des
courbes qui ont plus de petits nombres premiers d'Elkies.

Analyse du coût de l'algorithme \ref{alg:steptors}.

Cela amène à vouloir chercher des courbes dont la trace mod l a de
bonnes propriétés pour de petits l.


\subsection{Looking for a good initial curve}

Présenter la stratégie de
recherche SEA--early-abort. Cela vaut-il la peine de parler de la
sélection de candidats à l'aide d'une courbe modulaire, vu le peu que
cela fait gagner à la fin ? Je trouve que c'est intéressant, mais
l'intérêt est plutôt théorique je dirais.

\section{Experimental results}

On présente des paramètres pour viser à 128 bits de sécurité
classique.  Donner le corps de base choisi, et la meilleure courbe
obtenue par la recherche ci-dessus, la trace du Frobenius et le
discriminant de l'ordre maximal (qu'il faudra calculer avec ECM par
exemple, car on peut espérer qu'il n'a pas deux grands facteurs
premiers...), et une minoration explicite du nombre de classes.
Proposer aussi le nombre de pas à effectuer pour chaque nombre premier
d'Elkies.

Indiquer l'existence du paquet Julia avec un exemple complet d'échange
de clés. dire: tant de temps a été dépensé en
calculs de Frobenius, tant de temps en multiplications scalaires, etc.

Faire aussi des commentaires sur la sécurité quantique de ces
paramètres, en fonction de la discussion précédente. 

\section{Security}

Deux parties: d'abord la sécurité classique, ensuite la sécurité quantique.

Au niveau classique, on indique l'algorithme de Galbraith (\& Hess \&
Smart, ou \& Stolbunov...). Peut-être mentionner le fait que la
sécurité repose sur des heuristiques, à savoir une bonne répartition
des marches aléatoires dans le graphe, à des niveaux très inférieurs à
ce que peut garantir GRH.  Il reste des questions non résolues: quelle
est l'impact de la structure de groupe ? (Dans ses slides Stolbunov
insiste beaucoup pour avoir un groupe cyclique, je n'en vois pas
vraiment l'intérêt si ce n'est une forme de superstition !)  Est-ce
que la structure supplémentaire des courbes peut être exploitée ?

Au niveau quantique: l'attaque est certes sous-exponentielle, mais on
peut tout de même tenter d'évaluer des paramètres de sécurité. On peut
peut-être s'inspirer des recommandations du NIST ? Quelles ressources
demande l'attaque de Childs et al. relativement à ce que le NIST
envisage ?


\section{Conclusion}

- A quel point a-t-on accéléré le cryptosystème ?
- Ce protocole a-t-il finalement un intérêt dans le cadre de la crypto post-quantique ?


\bibliographystyle{plain}
\bibliography{refs}

\end{document}

%  LocalWords:  Rostovtsev Stolbunov isogenies morphism isogeny
%  LocalWords:  isomorphism coprime isogenous endomorphism
%  LocalWords:  Endomorphisms cryptosystem
